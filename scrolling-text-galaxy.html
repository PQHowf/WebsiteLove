<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content>
        <meta name="keywords" content>
        <title>WebsiteLove</title>

        <!-- Favicons -->
        <link href="assets/img/favicon.png" rel="icon">
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com" rel="preconnect">
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap"
            rel="stylesheet">

        <!-- Vendor CSS Files -->
        <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
        <link href="assets/vendor/aos/aos.css" rel="stylesheet">
        <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
        <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

        <!-- Main CSS File -->
        <link href="assets/css/main.css" rel="stylesheet">
    </head>
    <body class="index-page">
        <header id="header" class="header d-flex align-items-center sticky-top">
            <div
                class="container-fluid position-relative d-flex align-items-center justify-content-start">
                <a href="index.html" class="logo d-flex align-items-center me-auto me-xl-0">
                    <i class="bi bi-chat-heart"></i>
                    <h1 class="sitename">WebsiteLove</h1>
                </a>

                <nav id="navmenu" class="navmenu ms-3 mt-2">
                    <ul>
                        <li><a href="index.html">Website Love<br></a></li>
                        <li><a href="scrolling-text-galaxy.html?index=0">Scolling Text In
                                Galaxy</a></li>
                    </ul>
                    <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
                </nav>
            </div>
        </header>
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <h2>Những điều tốt đẹp đều cần thời gian...</h2>
            <p>Vui lòng đợi trong giây lát</p>
        </div>

        <div class="error-screen" id="errorScreen">
            <div class="error-icon">😢</div>
            <h2>Không tìm thấy website</h2>
            <p>Link này có thể đã hết hạn hoặc không tồn tại.</p>
            <a href="index.html" class="back-home">🏠 Về trang chủ</a>
        </div>

        <div class="galaxy-container" id="galaxy">
            <!-- Các text particles sẽ được tạo bằng JavaScript -->
        </div>

        <audio id="galaxyAudio" controls style="display:none"></audio>

        <script type="module">
            import { db, doc, getDoc } from "./assets/js/firebase-config.js";

// Lấy galaxy ID từ URL
const urlParams = new URLSearchParams(window.location.search);
const galaxyId = urlParams.get("id");
const isDemo = urlParams.get("index") === "0";

const demoGalaxyData = {
  messages: [
    "Anh yêu em nhìuuuuu ❤️",
    "Bapyeuoiiiii",
    "I love you 💖",
    "24/06/2003",
    "01/10/2006",
    "Hàu yêu Bắpppp",
    "🦪 ❤️ 🌽",
    "Yêu emmmmmm",
  ],
  icons: ["🥰", "😍", "😘", "❤️", "💕", "🌽", "🦪"],
  colors: {
    love: "#ff6b9d",
    birthday: "#4ecdc4",
    date: "#ff69b4",
    special: "#ff6b9d",
    heart: "#ff69b4",
  },
  images: [
    "assets/img/1.JPEG",
    "assets/img/2.JPEG",
    "assets/img/3.JPEG",
    "assets/img/4.JPEG",
    "assets/img/5.JPEG",
    "assets/img/6.JPEG",
    "assets/img/7.jpg",
  ],
  song: "Dangrangto_Love-is.mp3",
  createdAt: "2025-05-30T00:00:00.000Z",
};

const loadingScreen = document.getElementById("loadingScreen");
const errorScreen = document.getElementById("errorScreen");
const galaxy = document.getElementById("galaxy");

let galaxyData = null;
let rotationX = 0;
let rotationY = 0;
let scale = 1;
let isDragging = false;
let lastMouseX = 0;
let lastMouseY = 0;
const activeParticles = new Set();

// Responsive settings
const isMobile = window.innerWidth <= 768;
const isSmallMobile = window.innerWidth <= 480;
// Tăng số lượng particle tối đa
const maxParticles = isSmallMobile ? 150 : isMobile ? 200 : 300;
// Giảm thời gian giữa các lần tạo particle (tăng tần suất)
const particleInterval = isMobile ? 100 : 120;
const starCount = isSmallMobile ? 250 : isMobile ? 350 : 500;

let particleSpeedMultiplier = 1.3; // 1 là bình thường, >1 là chậm lại

// Làm chậm khi ấn giữ chuột hoặc giữ tay trên màn hình
document.addEventListener("mousedown", () => {
  particleSpeedMultiplier = 1.7;
});
document.addEventListener("mouseup", () => {
  particleSpeedMultiplier = 1;
});
document.addEventListener("touchstart", (e) => {
  // Chỉ làm chậm khi chỉ có 1 ngón (không phải pinch zoom)
  if (e.touches.length === 1) particleSpeedMultiplier = 1.7;
});
document.addEventListener("touchend", () => {
  particleSpeedMultiplier = 1;
});

// Prevent scrolling and zooming
document.addEventListener(
  "touchmove",
  function (e) {
    e.preventDefault();
  },
  { passive: false }
);

document.addEventListener(
  "wheel",
  function (e) {
    e.preventDefault();
  },
  { passive: false }
);

document.addEventListener("gesturestart", function (e) {
  e.preventDefault();
});

document.addEventListener("gesturechange", function (e) {
  e.preventDefault();
});

document.addEventListener("gestureend", function (e) {
  e.preventDefault();
});

// Load galaxy data from Firebase
async function loadGalaxyData() {
  if (isDemo) {
    galaxyData = demoGalaxyData;
    initializeGalaxy();
    return;
  }
  if (!galaxyId) {
    showError();
    return;
  }

  try {
    const docRef = doc(db, "galaxies", galaxyId);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      galaxyData = docSnap.data();
      initializeGalaxy();
    } else {
      showError();
    }
  } catch (error) {
    console.error("Error loading galaxy:", error);
    showError();
  }
}

function showError() {
  loadingScreen.style.display = "none";
  errorScreen.style.display = "flex";
}

function initializeGalaxy() {
  loadingScreen.style.display = "none";

  // Apply custom colors to CSS
  const style = document.createElement("style");
  style.textContent = `
                .text-particle.love { color: ${galaxyData.colors.love}; text-shadow: 0 0 15px ${galaxyData.colors.love}, 0 0 25px ${galaxyData.colors.love}, 0 0 35px ${galaxyData.colors.love}, 2px 2px 6px rgba(0,0,0,0.9); }
                .text-particle.birthday { color: ${galaxyData.colors.birthday}; text-shadow: 0 0 15px ${galaxyData.colors.birthday}, 0 0 25px ${galaxyData.colors.birthday}, 0 0 35px ${galaxyData.colors.birthday}, 2px 2px 6px rgba(0,0,0,0.9); }
                .text-particle.date { color: ${galaxyData.colors.date}; text-shadow: 0 0 20px ${galaxyData.colors.date}, 0 0 30px ${galaxyData.colors.date}, 0 0 40px ${galaxyData.colors.date}, 2px 2px 6px rgba(0,0,0,0.9); }
                .text-particle.special { color: ${galaxyData.colors.special}; text-shadow: 0 0 15px ${galaxyData.colors.special}, 0 0 25px ${galaxyData.colors.special}, 0 0 35px ${galaxyData.colors.special}, 2px 2px 6px rgba(0,0,0,0.9); }
                .text-particle.heart { color: ${galaxyData.colors.heart}; text-shadow: 0 0 20px ${galaxyData.colors.heart}, 0 0 30px ${galaxyData.colors.heart}, 0 0 40px ${galaxyData.colors.heart}, 3px 3px 8px rgba(0,0,0,0.9); }
            `;
  document.head.appendChild(style);

  // Phát nhạc nếu có
  if (galaxyData.song) {
    const audio = document.getElementById("galaxyAudio");
    if (galaxyData.song.startsWith("http")) {
      audio.src = galaxyData.song;
    } else {
      audio.src = `assets/songs/${galaxyData.song}`;
    }
    // Tự động phát thử (sẽ bị chặn trên mobile)
    audio.play().catch(() => {});
    // Thêm đoạn này để phát khi user chạm lần đầu
    const playAudioOnUserGesture = () => {
      audio.play().catch(() => {});
      document.removeEventListener("touchstart", playAudioOnUserGesture);
      document.removeEventListener("click", playAudioOnUserGesture);
    };
    document.addEventListener("touchstart", playAudioOnUserGesture);
    document.addEventListener("click", playAudioOnUserGesture);
  }

  createStars();
  startParticleAnimation();
}

function getRandomMessage() {
  return galaxyData.messages[
    Math.floor(Math.random() * galaxyData.messages.length)
  ];
}

function getRandomIcon() {
  return galaxyData.icons[Math.floor(Math.random() * galaxyData.icons.length)];
}

function getMessageClass(message) {
  const lowerMessage = message.toLowerCase();
  if (
    lowerMessage.includes("love") ||
    lowerMessage.includes("yêu") ||
    lowerMessage.includes("tình")
  ) {
    return "love";
  } else if (
    lowerMessage.includes("birthday") ||
    lowerMessage.includes("sinh nhật") ||
    lowerMessage.includes("chúc mừng")
  ) {
    return "birthday";
  } else if (/\d/.test(message) || message.includes("/")) {
    return "date";
  } else {
    return "special";
  }
}

function createTextParticle() {
  if (activeParticles.size >= maxParticles) {
    return;
  }

  const isIcon = Math.random() > 0.7;
  const element = document.createElement("div");

  if (isIcon) {
    element.className = "text-particle heart";
    element.textContent = getRandomIcon();
  } else {
    const message = getRandomMessage();
    element.className = `text-particle ${getMessageClass(message)}`;
    element.textContent = message;
  }

  const xPos = Math.random() * 100;
  const zPos = (Math.random() - 0.5) * (isMobile ? 300 : 500);
  const animationDuration = Math.random() * 2 + (isMobile ? 3 : 3);

  element.style.left = xPos + "%";

  const baseFontSize = isSmallMobile ? 8 : isMobile ? 12 : 18; // desktop to hơn
  const fontSizeVariation = isSmallMobile ? 4 : isMobile ? 5 : 8;
  element.style.fontSize =
    Math.random() * fontSizeVariation + baseFontSize + "px";

  const depthOpacity = Math.max(
    0.4,
    1 - Math.abs(zPos) / (isMobile ? 250 : 400)
  );
  element.style.opacity = depthOpacity;

  let startTime = null;
  let startY = -150;
  let endY = window.innerHeight + 150;
  const thisParticleSpeed = particleSpeedMultiplier; // Lưu multiplier tại thời điểm tạo

  function animateParticle(timestamp) {
    if (!startTime) startTime = timestamp;
    const progress =
      (timestamp - startTime) / (animationDuration * 1000 * thisParticleSpeed);

    if (progress < 1) {
      const currentY = startY + (endY - startY) * progress;
      const opacity =
        progress < 0.05
          ? progress * 20
          : progress > 0.95
          ? (1 - progress) * 20
          : depthOpacity;

      element.style.transform = `translate3d(0, ${currentY}px, ${zPos}px)`;
      element.style.opacity = opacity;

      requestAnimationFrame(animateParticle);
    } else {
      if (element.parentNode) {
        element.parentNode.removeChild(element);
        activeParticles.delete(element);
      }
    }
  }

  galaxy.appendChild(element);
  activeParticles.add(element);
  requestAnimationFrame(animateParticle);
}

function createStars() {
  for (let i = 0; i < starCount; i++) {
    const star = document.createElement("div");
    star.className = "star";

    const angle = Math.random() * Math.PI * 10;
    const radius =
      Math.random() * (isMobile ? 800 : 1500) + (isMobile ? 200 : 300);
    const spiralHeight = Math.sin(angle) * (isMobile ? 100 : 150);

    const x = Math.cos(angle) * radius;
    const y = spiralHeight + (Math.random() - 0.5) * (isMobile ? 1000 : 2000);
    const z = Math.sin(angle) * radius * 0.5;

    star.style.left = `calc(50% + ${x}px)`;
    star.style.top = `calc(50% + ${y}px)`;
    star.style.transform = `translateZ(${z}px)`;
    star.style.animationDelay = Math.random() * 3 + "s";

    const depthBrightness = Math.max(
      0.1,
      1 - Math.abs(z) / (isMobile ? 800 : 1200)
    );
    star.style.opacity = depthBrightness;

    galaxy.appendChild(star);
  }
}

function updateGalaxyTransform() {
  requestAnimationFrame(() => {
    galaxy.style.transform = `translate(-50%, -50%) rotateX(${rotationX}deg) rotateY(${rotationY}deg) scale(${scale})`;
  });
}

function startParticleAnimation() {
  setInterval(() => {
    // 20% xác suất tạo ảnh, còn lại là icon/chữ
    if (
      galaxyData.images &&
      galaxyData.images.length > 0 &&
      Math.random() < 0.08
    ) {
      createImageParticle();
    } else {
      createTextParticle();
    }
  }, particleInterval);

  const initialParticles = isMobile ? 5 : 15;
  for (let i = 0; i < initialParticles; i++) {
    setTimeout(() => {
      if (
        galaxyData.images &&
        galaxyData.images.length > 0 &&
        Math.random() < 0.08
      ) {
        createImageParticle();
      } else {
        createTextParticle();
      }
    }, i * (particleInterval * 0.6));
  }
}

// Mouse events for desktop
document.addEventListener("mousedown", (e) => {
  isDragging = true;
  lastMouseX = e.clientX;
  lastMouseY = e.clientY;
});

document.addEventListener("mousemove", (e) => {
  if (isDragging) {
    const deltaX = e.clientX - lastMouseX;
    const deltaY = e.clientY - lastMouseY;

    const sensitivity = isMobile ? 0.3 : 0.5;
    rotationY += deltaX * sensitivity;
    rotationX -= deltaY * sensitivity;

    updateGalaxyTransform();

    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
  }
});

document.addEventListener("mouseup", () => {
  isDragging = false;
});

// Enhanced touch events for mobile
let initialDistance = 0;
let initialScale = 1;

document.addEventListener(
  "touchstart",
  (e) => {
    e.preventDefault();

    if (e.touches.length === 1) {
      isDragging = true;
      lastMouseX = e.touches[0].clientX;
      lastMouseY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
      isDragging = false;
      const touch1 = e.touches[0];
      const touch2 = e.touches[1];
      initialDistance = Math.sqrt(
        Math.pow(touch2.clientX - touch1.clientX, 2) +
          Math.pow(touch2.clientY - touch1.clientY, 2)
      );
      initialScale = scale;
    }
  },
  { passive: false }
);

document.addEventListener(
  "touchmove",
  (e) => {
    e.preventDefault();

    if (e.touches.length === 1 && isDragging) {
      const deltaX = e.touches[0].clientX - lastMouseX;
      const deltaY = e.touches[0].clientY - lastMouseY;

      const sensitivity = 0.3;
      rotationY += deltaX * sensitivity;
      rotationX -= deltaY * sensitivity;

      updateGalaxyTransform();

      lastMouseX = e.touches[0].clientX;
      lastMouseY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
      const touch1 = e.touches[0];
      const touch2 = e.touches[1];
      const currentDistance = Math.sqrt(
        Math.pow(touch2.clientX - touch1.clientX, 2) +
          Math.pow(touch2.clientY - touch1.clientY, 2)
      );

      const scaleChange = currentDistance / initialDistance;
      scale = Math.max(0.5, Math.min(2, initialScale * scaleChange));

      updateGalaxyTransform();
    }
  },
  { passive: false }
);

document.addEventListener(
  "touchend",
  (e) => {
    e.preventDefault();
    isDragging = false;
  },
  { passive: false }
);

// Handle orientation change
window.addEventListener("orientationchange", () => {
  setTimeout(() => {
    location.reload();
  }, 100);
});

// Initialize
loadGalaxyData();

function createImageParticle() {
  if (
    !galaxyData.images ||
    galaxyData.images.length === 0 ||
    activeParticles.size >= maxParticles
  )
    return;

  const img = document.createElement("img");
  img.src =
    galaxyData.images[Math.floor(Math.random() * galaxyData.images.length)];
  img.className = "text-particle image-particle";
  img.style.width = Math.random() * 40 + 60 + "px"; // 80-120px, to hơn và đẹp hơn
  img.style.height = "auto";
  img.style.borderRadius = "15px";
  img.style.boxShadow = "0 4px 24px rgba(0,0,0,0.18)";
  img.style.background = "#fff";

  const xPos = Math.random() * 100;
  const zPos = (Math.random() - 0.5) * (isMobile ? 300 : 500);
  const animationDuration = Math.random() * 2 + (isMobile ? 3 : 3);

  img.style.left = xPos + "%";

  let startTime = null;
  let startY = -150;
  let endY = window.innerHeight + 150;
  const thisParticleSpeed = particleSpeedMultiplier;

  function animateParticle(timestamp) {
    if (!startTime) startTime = timestamp;
    const progress =
      (timestamp - startTime) / (animationDuration * 1000 * thisParticleSpeed);

    if (progress < 1) {
      const currentY = startY + (endY - startY) * progress;
      const opacity =
        progress < 0.05
          ? progress * 20
          : progress > 0.95
          ? (1 - progress) * 20
          : 1;
      img.style.transform = `translate3d(0, ${currentY}px, ${zPos}px)`;
      img.style.opacity = opacity;

      requestAnimationFrame(animateParticle);
    } else {
      if (img.parentNode) {
        img.parentNode.removeChild(img);
        activeParticles.delete(img);
      }
    }
  }

  galaxy.appendChild(img);
  activeParticles.add(img);
  requestAnimationFrame(animateParticle);
}

        </script>
        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

        <!-- Main JS File -->
        <script type="module" src="assets/js/main.js"></script>
    </body>
</html>